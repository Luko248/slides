<style>
  .confetti-wrap {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
    z-index: -10;
  }

  .confetti-canvas {
    display: block;
    inline-size: 100%;
    block-size: 100%;
  }

  @media (prefers-reduced-motion: reduce) {
    .confetti-wrap {
      display: none;
    }
  }
</style>

<div class="confetti-wrap" aria-hidden="true">
  <canvas class="confetti-canvas" data-confetti-canvas></canvas>
</div>

<script is:inline>
  (() => {
    const script = document.currentScript;
    if (!script) return;

    const wrap = script.previousElementSibling;
    if (!(wrap instanceof HTMLElement)) return;

    const canvas = wrap.querySelector("[data-confetti-canvas]");
    if (!(canvas instanceof HTMLCanvasElement)) return;

    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const colors = ["#f94144", "#f3722c", "#f9c74f", "#90be6d", "#43aa8b", "#577590"];
    const particleCount = 120;
    const particles = [];
    const maxDpr = 2;

    let width = 0;
    let height = 0;
    let dpr = Math.min(window.devicePixelRatio || 1, maxDpr);
    let rafId = 0;

    const random = (min, max) => Math.random() * (max - min) + min;

    const createParticle = (spawnAbove = true) => ({
      x: random(0, width || 1),
      y: spawnAbove ? random(-height, 0) : random(0, height || 1),
      size: random(4, 10),
      color: colors[Math.floor(Math.random() * colors.length)],
      speedX: random(-1.2, 1.2),
      speedY: random(1.6, 4.4),
      tilt: random(0, Math.PI * 2),
      tiltSpeed: random(0.02, 0.08),
    });

    const resize = () => {
      const rect = wrap.getBoundingClientRect();
      width = Math.max(1, rect.width);
      height = Math.max(1, rect.height);
      dpr = Math.min(window.devicePixelRatio || 1, maxDpr);

      canvas.width = Math.floor(width * dpr);
      canvas.height = Math.floor(height * dpr);
      canvas.style.width = `${width}px`;
      canvas.style.height = `${height}px`;

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    };

    const drawParticle = (p) => {
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.tilt);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
      ctx.restore();
    };

    const frame = () => {
      ctx.clearRect(0, 0, width, height);

      for (let i = 0; i < particles.length; i += 1) {
        const p = particles[i];
        p.x += p.speedX;
        p.y += p.speedY;
        p.tilt += p.tiltSpeed;

        if (p.y > height + 20) {
          particles[i] = createParticle(true);
          continue;
        }

        if (p.x < -20) p.x = width + 20;
        if (p.x > width + 20) p.x = -20;

        drawParticle(p);
      }

      rafId = window.requestAnimationFrame(frame);
    };

    resize();
    for (let i = 0; i < particleCount; i += 1) {
      particles.push(createParticle(false));
    }
    frame();

    window.addEventListener("resize", resize, { passive: true });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        window.cancelAnimationFrame(rafId);
        return;
      }
      window.cancelAnimationFrame(rafId);
      frame();
    });
  })();
</script>
